# 手書き文字判定アプリ (imgrec) 仕様書

## 1. 概要
本アプリケーションは、ユーザーが撮影した「手書き数字」の画像をアップロードし、AI (CNN) を用いてその数字を自動判定するWebアプリケーションです。
通常のMNISTデータセット（綺麗に整形された画像）ではなく、**現実世界の手書き写真**を認識させるために、OpenCVを用いた高度な画像前処理を実装しています。

## 2. システム構成
*   **言語**: Python 3.11
*   **UIフレームワーク**: Flet
*   **画像処理ライブラリ**: OpenCV (opencv-python), NumPy
*   **AI/機械学習ライブラリ**: TensorFlow, Keras

### 2.1 ディレクトリ構成
```text
imgrec/
├── src/
│   ├── main.py       # アプリケーション本体
│   └── assets/
│       └── uploads/  # 画像一時保存用 (Webモード対応のため)
└── docs/
    └── spec.md       # 本仕様書
```

## 3. 機能詳細

### 3.1 画像前処理パイプライン (OpenCV)
ユーザーがアップロードした任意の画像を、AIが学習したデータ形式 (MNIST: 28x28ピクセル, 黒背景, 白文字) に適合させるため、以下の手順で変換を行います。function `process_image` に実装されています。

```mermaid
graph TD
    Raw[元画像 (写真)] --> Decode[画像読み込み (NumPy経由)]
    Decode --> Gray[グレースケール変換]
    Gray --> Blur[ノイズ除去 (ガウシアンフィルタ)]
    Blur --> Threshold[2値化 & 反転 (Otsu's Method)]
    Threshold --> Contours[輪郭抽出 (文字特定)]
    Contours --> Crop[文字領域の切り出し]
    Crop --> Resize[リサイズ (アスペクト比維持)]
    Resize --> Center[センタリング (28x28配置)]
    Center --> Input[AI入力データ]
```

1.  **画像読み込み**: 日本語パス等に対応するため、`cv2.imread` ではなく `np.fromfile` + `cv2.imdecode` を使用。
2.  **グレースケール変換 (`cv2.cvtColor`)**: カラー情報を捨て、輝度情報のみにします。
3.  **ノイズ除去 (`cv2.GaussianBlur`)**: 5x5のカーネルで平滑化し、紙のざらつきや細かいごみを除去します。
4.  **2値化 & 反転 (`cv2.threshold`)**:
    *   `cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU` を使用。
    *   **Otsu's Method**: 最適なしきい値を自動計算。
    *   **Inverse**: 紙（白）を背景（黒）、文字（黒）を線（白）に反転させます (MNIST形式への適合)。
5.  **文字領域の特定と切り出し (`cv2.findContours`)**:
    *   最も面積の大きい輪郭を「文字」と推定。
    *   `cv2.boundingRect` で矩形を計算し、パディング(20px)を加えて切り出します。
6.  **リサイズとセンタリング**:
    *   アスペクト比を維持したまま、長辺が20pxになるように縮小。
    *   28x28ピクセルの黒いキャンバスの中心に配置します。

### 3.2 AIモデル (CNN)
MNISTデータセットで学習させた畳み込みニューラルネットワーク (CNN) を使用します。`train_cnn_model` 関数で構築・学習されます。

| 層 | 設定 | 役割 |
| :--- | :--- | :--- |
| **Conv2D** | 32 filters, 3x3, ReLU | 画像の局所的な特徴（エッジ等）を抽出 |
| **MaxPooling2D** | 2x2 | 特徴マップを圧縮し、位置ズレへのロバスト性を向上 |
| **Flatten** | - | 2次元データを1次元ベクトルに変換 |
| **Dense** | 128, ReLU | 分類のための高次元な特徴抽出 |
| **Dense** | 10, Softmax | 0-9の各クラスに対する確率を出力 |

*   **学習**: アプリ起動時にMNISTデータをダウンロードし、`epochs=3` で高速に学習を行います。

## 4. UI仕様とフロー
1.  **起動**: アプリ起動時にCNNモデルの学習が行われます（コンソールに進捗表示）。
2.  **画像選択**: 「画像をアップロード」ボタンで写真を選択。
3.  **アップロード (Webモード対応)**:
    *   選択されたファイルは `src/assets/uploads/` に一時的にアップロードされます。
    *   これは、Webブラウザ上のFletクライアントからサーバー側のOpenCVがファイルにアクセスするために必要です。
4.  **結果表示**:
    *   **元の写真**: アップロードされた画像をそのまま表示。
    *   **AI入力用**: 前処理後の28x28画像を表示。AIが「何を」見ているかが分かります。
    *   **判定テキスト**: 「AIの判定: X (確信度: Y%)」の形式で結果を表示します。
